<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„íŒŒíŠ¸ ë¶„ì–‘ê¶Œ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root { --navy:#022136; --gold:#A78569; --gold-light:#f5efe9; --red:#e74c3c; --green:#27ae60; --blue:#2980b9; --bg:#f5f5f7; --card:#fff; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:"Pretendard Variable",Pretendard,-apple-system,sans-serif; background:var(--bg); color:var(--navy); padding:48px 20px; display:flex; flex-direction:column; align-items:center; -webkit-font-smoothing:antialiased; letter-spacing:-0.02em; }
        .container { width:100%; max-width:1200px; }
        header { text-align:center; margin-bottom:48px; }
        h1 { font-size:38px; font-weight:800; letter-spacing:-0.05em; margin-bottom:8px; }
        .subtitle { font-size:17px; color:var(--gold); font-weight:600; }

        .top-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:32px; }
        .top-stat { background:var(--card); border-radius:20px; padding:28px 20px; text-align:center; border:1px solid rgba(0,0,0,0.04); }
        .top-stat-icon { font-size:28px; margin-bottom:10px; }
        .top-stat-label { font-size:13px; color:#888; font-weight:500; margin-bottom:6px; }
        .top-stat-value { font-size:26px; font-weight:800; letter-spacing:-0.03em; }

        .filter-bar { background:var(--card); border-radius:20px; padding:24px 28px; margin-bottom:32px; display:flex; gap:16px; align-items:end; border:1px solid rgba(0,0,0,0.04); flex-wrap:wrap; }
        .filter-item { flex:1; min-width:160px; }
        .filter-item label { display:block; font-size:12px; font-weight:600; color:#888; margin-bottom:6px; }
        .filter-item select,.filter-item input { width:100%; padding:10px 14px; border:1px solid #e0e0e0; border-radius:12px; font-size:14px; font-family:inherit; background:#fff; }
        .filter-item select:focus,.filter-item input:focus { outline:none; border-color:var(--gold); }

        .apt-card { background:var(--card); border-radius:24px; margin-bottom:24px; border:1px solid rgba(0,0,0,0.04); overflow:hidden; }
        .apt-card-header { padding:28px 32px 20px; display:flex; justify-content:space-between; align-items:center; }
        .apt-name { font-size:22px; font-weight:800; letter-spacing:-0.03em; }
        .apt-location { font-size:14px; color:#888; font-weight:500; margin-top:4px; }
        .apt-badges { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .apt-badge { padding:8px 16px; border-radius:12px; font-size:14px; font-weight:700; }
        .badge-count { background:var(--gold-light); color:var(--gold); }
        .badge-range { background:#eef6ff; color:var(--blue); }

        .type-table-wrap { padding:0 32px 28px; }
        .type-table { width:100%; border-collapse:separate; border-spacing:0; }
        .type-table thead th { font-size:12px; font-weight:700; color:#888; padding:12px 14px; text-align:left; border-bottom:2px solid #f0f0f0; white-space:nowrap; }
        .type-table thead th.r { text-align:right; }
        .type-table tbody td { padding:14px; font-size:14px; font-weight:500; border-bottom:1px solid #f5f5f5; vertical-align:middle; }
        .type-table tbody tr:last-child td { border-bottom:none; }
        .type-table tbody tr:hover { background:#fafbfc; }
        .type-name { font-weight:700; color:var(--navy); }
        .type-area { font-size:13px; color:#999; font-weight:500; }
        .td-r { text-align:right; font-variant-numeric:tabular-nums; }
        .price-min { color:var(--green); font-weight:700; }
        .price-max { color:var(--red); font-weight:700; }
        .count-badge { display:inline-block; background:var(--gold-light); color:var(--gold); padding:3px 10px; border-radius:8px; font-weight:700; font-size:13px; }
        .p-neg { color:var(--red); font-weight:700; }
        .p-pos { color:var(--green); font-weight:700; }

        .detail-btn { background:none; border:1px solid #e0e0e0; border-radius:8px; padding:4px 10px; font-size:11px; font-family:inherit; cursor:pointer; color:#888; font-weight:600; transition:all 0.2s; }
        .detail-btn:hover { border-color:var(--gold); color:var(--gold); }
        .detail-panel { display:none; }
        .detail-panel.open { display:table-row; }
        .detail-inner { padding:12px 16px; background:#fafbfc; }
        .detail-inner table { width:100%; border-collapse:collapse; }
        .detail-inner th { font-size:11px; color:#999; font-weight:700; padding:6px 8px; text-align:left; }
        .detail-inner th.r { text-align:right; }
        .detail-inner td { font-size:13px; padding:8px; border-top:1px solid #eee; }
        .detail-inner td.r { text-align:right; }

        .loading-section { text-align:center; padding:100px 20px; background:var(--card); border-radius:24px; }
        .loading-icon { font-size:48px; animation:spin 2s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
        .loading-text { font-size:16px; color:#888; margin-top:16px; }
        .error-section { background:#fff5f5; border:2px solid #feb2b2; color:#c53030; padding:40px; border-radius:24px; text-align:center; display:none; }

        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .chart-section { display:none; margin-bottom:32px; }
        .chart-section.show { display:block; }
        .chart-card { background:var(--card); border-radius:24px; padding:28px 32px; border:1px solid rgba(0,0,0,0.04); }
        .chart-title { font-size:16px; font-weight:700; margin-bottom:6px; letter-spacing:-0.03em; }
        .chart-subtitle { font-size:13px; color:#999; margin-bottom:20px; }
        .chart-legend { display:flex; gap:16px; margin-bottom:18px; }
        .legend-item { display:flex; align-items:center; gap:5px; font-size:12px; font-weight:600; color:#888; }
        .legend-dot { width:8px; height:8px; border-radius:50%; }
        .legend-59 { background:#8CBBCF; }
        .legend-84 { background:#CBAB8F; }
        .chart-row { display:flex; align-items:center; gap:10px; margin-bottom:6px; height:28px; }
        .chart-row:last-child { margin-bottom:0; }
        .chart-label { width:140px; min-width:140px; font-size:12px; font-weight:600; color:var(--navy); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:right; }
        .chart-bars { flex:1; display:flex; flex-direction:column; gap:2px; justify-content:center; }
        .chart-bar { height:12px; border-radius:3px; transition:width 0.5s ease; min-width:2px; }
        .chart-bar-59 { background:#8CBBCF; }
        .chart-bar-84 { background:#CBAB8F; }
        .chart-val { width:90px; min-width:90px; font-size:11px; font-weight:600; color:#999; font-variant-numeric:tabular-nums; line-height:1.5; }

        @media (max-width:768px) {
            .top-stats { grid-template-columns:repeat(2,1fr); }
            .filter-bar { flex-direction:column; }
            .apt-card-header { flex-direction:column; align-items:flex-start; gap:12px; }
            .type-table-wrap { padding:0 16px 20px; overflow-x:auto; }
            h1 { font-size:28px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¢ ë¶„ì–‘ê¶Œ ë§¤ë¬¼ ìš”ì•½</h1>
            <div class="subtitle">ì•„íŒŒíŠ¸ë³„ Â· í‰í˜•ë³„ ê°€ê²© ìš”ì•½ ëŒ€ì‹œë³´ë“œ</div>
        </header>

        <div id="loadingSection" class="loading-section">
            <div class="loading-icon">â³</div>
            <div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
        <div id="errorSection" class="error-section">
            <div style="font-size:48px;margin-bottom:16px;">âŒ</div>
            <div id="errorMessage" style="font-size:15px;line-height:1.8;"></div>
        </div>

        <div id="mainContent" style="display:none;">
            <div class="top-stats">
                <div class="top-stat"><div class="top-stat-icon">ğŸ </div><div class="top-stat-label">ì´ ë‹¨ì§€ ìˆ˜</div><div class="top-stat-value" id="statAptCount">0</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ“‹</div><div class="top-stat-label">ì´ ë§¤ë¬¼ ìˆ˜</div><div class="top-stat-value" id="statTotalCount">0</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ’°</div><div class="top-stat-label">ìµœì €ê°€</div><div class="top-stat-value" id="statMinPrice">-</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ“ˆ</div><div class="top-stat-label">ìµœê³ ê°€</div><div class="top-stat-value" id="statMaxPrice">-</div></div>
            </div>
            <div class="filter-bar">
                <div class="filter-item"><label>ê´‘ì—­ì‹œë„</label><select id="filterMajor" onchange="onMajorChange()"><option value="">ì „ì²´</option></select></div>
                <div class="filter-item"><label>ì„¸ë¶€ì§€ì—­</label><select id="filterMinor" onchange="applyFilters()"><option value="">ì „ì²´</option></select></div>
                <div class="filter-item"><label>ë‹¨ì§€ëª… ê²€ìƒ‰</label><input type="text" id="filterName" placeholder="ë‹¨ì§€ëª… ì…ë ¥" oninput="applyFilters()"></div>
                <div class="filter-item"><label>ì •ë ¬</label><select id="sortBy" onchange="applyFilters()"><option value="name">ì´ë¦„ìˆœ</option><option value="count-desc">ë§¤ë¬¼ ë§ì€ìˆœ</option><option value="price-asc">ìµœì €ê°€ ë‚®ì€ìˆœ</option><option value="price-desc">ìµœê³ ê°€ ë†’ì€ìˆœ</option></select></div>
            </div>
            <div id="chartSection" class="chart-section">
                <div class="chart-card">
                    <div class="chart-title" id="chartTitle">ë‹¨ì§€ë³„ ìµœì €ê°€ ë¹„êµ</div>
                    <div class="chart-subtitle" id="chartSubtitle">59mÂ² Â· 84mÂ² ê¸°ì¤€</div>
                    <div class="chart-legend">
                        <div class="legend-item"><div class="legend-dot legend-59"></div>59mÂ²</div>
                        <div class="legend-item"><div class="legend-dot legend-84"></div>84mÂ²</div>
                    </div>
                    <div id="chartBars"></div>
                </div>
            </div>
            <div id="aptContainer"></div>
        </div>
    </div>

    <script>
        let allData = [];
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNbiO170sxkjo_rgOvvis5eTZP0VYfm1aYetd792BcWwXs-b1BsRtX9DQha6LlZkfRIIE_4IIeplIM/pub?gid=0&single=true&output=csv';
        window.onload = loadData;

        async function loadData() {
            const methods = [
                () => fetch(SHEET_CSV_URL).then(r=>{if(!r.ok)throw 0;return r.text()}),
                () => fetch('https://api.allorigins.win/raw?url='+encodeURIComponent(SHEET_CSV_URL)).then(r=>{if(!r.ok)throw 0;return r.text()}),
                () => fetch('https://corsproxy.io/?'+encodeURIComponent(SHEET_CSV_URL)).then(r=>{if(!r.ok)throw 0;return r.text()}),
            ];
            let text=null;
            for(const m of methods){try{text=await Promise.race([m(),new Promise((_,r)=>setTimeout(()=>r('t'),6000))]);if(text&&text.length>20)break;text=null;}catch(e){text=null;}}
            if(!text){showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>êµ¬ê¸€ ì‹œíŠ¸ ì›¹ ê²Œì‹œ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');return;}
            try{parseCSV(text);buildRegionFilter();applyFilters();document.getElementById('loadingSection').style.display='none';document.getElementById('mainContent').style.display='block';}catch(e){showError('íŒŒì‹± ì‹¤íŒ¨: '+e.message);}
        }

        function parseCSV(text) {
            allData = [];
            const lines = csvParse(text);
            if (lines.length < 2) return;

            // í—¤ë” ìë™ ë§¤í•‘
            const h = lines[0].map(s => s.trim());
            const fi = (keywords) => h.findIndex(col => keywords.every(k => col.includes(k)));
            const I = {
                ì§€ì—­: h.findIndex((c,i) => c.includes('ì§€ì—­') && !c.includes('2')),
                ì§€ì—­2: fi(['ì§€ì—­2']) !== -1 ? fi(['ì§€ì—­2']) : fi(['ì§€ì—­','2']),
                ë‹¨ì§€ëª…: fi(['ë‹¨ì§€ëª…']),
                ë™: h.findIndex(c => c === 'ë™'),
                ê°€ê²©: h.findIndex((c,i) => c === 'ê°€ê²©'),
                ê°€ê²©ìˆ«ì: fi(['ê°€ê²©','ìˆ«ì']),
                ê³µê¸‰: fi(['ê³µê¸‰']),
                ì „ìš©: fi(['ì „ìš©']),
                ì¸µ: h.findIndex(c => c === 'ì¸µ'),
                ë°©í–¥: fi(['ë°©í–¥']),
                Pê¸ˆì•¡ìˆ«ì: fi(['Pê¸ˆì•¡','ìˆ«ì']),
                Pí…ìŠ¤íŠ¸: fi(['P','í…ìŠ¤íŠ¸']),
                ìƒì„¸ì„¤ëª…: fi(['ìƒì„¸']) !== -1 ? fi(['ìƒì„¸']) : fi(['ì„¤ëª…']),
                ì œê³µì—…ì²´: fi(['ì œê³µ']),
                ì¤‘ê°œì‚¬: fi(['ì¤‘ê°œ']),
                í™•ì¸ì¼: fi(['í™•ì¸']),
            };

            for (let i = 1; i < lines.length; i++) {
                const c = lines[i];
                const name = gc(c, I.ë‹¨ì§€ëª…);
                if (!name) continue;
                allData.push({
                    ì§€ì—­: gc(c, I.ì§€ì—­),
                    ì§€ì—­2: gc(c, I.ì§€ì—­2),
                    ë‹¨ì§€ëª…: name,
                    ë™: gc(c, I.ë™),
                    ê°€ê²©: gc(c, I.ê°€ê²©),
                    ê°€ê²©ìˆ«ì: numParse(gc(c, I.ê°€ê²©ìˆ«ì)),
                    ê³µê¸‰: gc(c, I.ê³µê¸‰),
                    ì „ìš©: gc(c, I.ì „ìš©),
                    ì¸µ: gc(c, I.ì¸µ),
                    ë°©í–¥: gc(c, I.ë°©í–¥),
                    Pê¸ˆì•¡ìˆ«ì: numParse(gc(c, I.Pê¸ˆì•¡ìˆ«ì)),
                    Pí…ìŠ¤íŠ¸: gc(c, I.Pí…ìŠ¤íŠ¸),
                    ìƒì„¸ì„¤ëª…: gc(c, I.ìƒì„¸ì„¤ëª…),
                    ì œê³µì—…ì²´: gc(c, I.ì œê³µì—…ì²´),
                    ì¤‘ê°œì‚¬: gc(c, I.ì¤‘ê°œì‚¬),
                    í™•ì¸ì¼: gc(c, I.í™•ì¸ì¼),
                });
            }
        }

        function gc(arr, i) { return (i >= 0 && i < arr.length) ? arr[i].trim() : ''; }
        function numParse(s) { return parseFloat((s||'').replace(/,/g, '')) || 0; }

        function csvParse(text) {
            const result = []; let row=[], cell='', inQ=false;
            for (let i=0; i<text.length; i++) {
                const ch=text[i], nx=text[i+1];
                if(inQ){if(ch==='"'&&nx==='"'){cell+='"';i++;}else if(ch==='"')inQ=false;else cell+=ch;}
                else{if(ch==='"')inQ=true;else if(ch===','){row.push(cell);cell='';}else if(ch==='\n'||(ch==='\r'&&nx==='\n')){row.push(cell);if(row.some(c=>c.trim()))result.push(row);row=[];cell='';if(ch==='\r')i++;}else cell+=ch;}
            }
            if(cell||row.length){row.push(cell);if(row.some(c=>c.trim()))result.push(row);}
            return result;
        }

        function getMajor(r) {
            const map = [['ì„œìš¸'],['ê²½ê¸°'],['ì¸ì²œ'],['ë¶€ì‚°'],['ëŒ€êµ¬'],['ëŒ€ì „'],['ê´‘ì£¼'],['ìš¸ì‚°'],['ì„¸ì¢…'],['ì¶©ë¶','ì¶©ì²­ë¶'],['ì¶©ë‚¨','ì¶©ì²­ë‚¨'],['ì „ë¶','ì „ë¼ë¶'],['ì „ë‚¨','ì „ë¼ë‚¨'],['ê²½ë¶','ê²½ìƒë¶'],['ê²½ë‚¨','ê²½ìƒë‚¨'],['ê°•ì›'],['ì œì£¼']];
            for (const m of map) { for (const prefix of m) { if (r.startsWith(prefix)) return m[0]; } }
            return r;
        }

        function buildRegionFilter() {
            const mm = {};
            allData.forEach(d => { const m = getMajor(d.ì§€ì—­); if(!mm[m])mm[m]=new Set(); mm[m].add(d.ì§€ì—­2); });
            const sel = document.getElementById('filterMajor');
            const order = ['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ë¶€ì‚°','ëŒ€êµ¬','ëŒ€ì „','ê´‘ì£¼','ìš¸ì‚°','ì„¸ì¢…'];
            Object.keys(mm).sort((a,b) => { const ai=order.indexOf(a),bi=order.indexOf(b); if(ai!==-1&&bi!==-1)return ai-bi; if(ai!==-1)return -1; if(bi!==-1)return 1; return a.localeCompare(b,'ko'); }).forEach(m => {
                const o = document.createElement('option'); o.value=m; o.textContent=m+' ('+mm[m].size+'ê°œ êµ¬/ì‹œ)'; sel.appendChild(o);
            });
            window._mm = mm;
        }

        function onMajorChange() {
            const major = document.getElementById('filterMajor').value;
            const ms = document.getElementById('filterMinor');
            ms.innerHTML = '<option value="">ì „ì²´</option>';
            if (major && window._mm[major]) {
                [...window._mm[major]].sort((a,b)=>a.localeCompare(b,'ko')).forEach(m => { const o=document.createElement('option');o.value=m;o.textContent=m;ms.appendChild(o); });
            }
            applyFilters();
        }

        function applyFilters() {
            const major=document.getElementById('filterMajor').value;
            const minor=document.getElementById('filterMinor').value;
            const name=document.getElementById('filterName').value.toLowerCase();
            const sortBy=document.getElementById('sortBy').value;
            let filtered=allData.filter(d=>(!major||getMajor(d.ì§€ì—­)===major)&&(!minor||d.ì§€ì—­2===minor)&&(!name||d.ë‹¨ì§€ëª….toLowerCase().includes(name)));

            const am={};
            filtered.forEach(d=>{const k=d.ë‹¨ì§€ëª…;if(!am[k])am[k]={ì§€ì—­:d.ì§€ì—­,ì§€ì—­2:d.ì§€ì—­2,items:[]};am[k].items.push(d);});
            let aptList=Object.entries(am).map(([n,data])=>{
                const tm={};
                data.items.forEach(d=>{const k=d.ì „ìš©;if(!tm[k])tm[k]={ì „ìš©:d.ì „ìš©,items:[]};tm[k].items.push(d);});
                const types=Object.values(tm).map(t=>{
                    const pr=t.items.map(i=>i.ê°€ê²©ìˆ«ì).filter(p=>p>0);
                    const pa=t.items.map(i=>i.Pê¸ˆì•¡ìˆ«ì).filter(p=>p!==0);
                    return{ì „ìš©:t.ì „ìš©,count:t.items.length,minPrice:pr.length?Math.min(...pr):0,maxPrice:pr.length?Math.max(...pr):0,minP:pa.length?Math.min(...pa):0,maxP:pa.length?Math.max(...pa):0,items:t.items};
                });
                const ap=data.items.map(i=>i.ê°€ê²©ìˆ«ì).filter(p=>p>0);
                return{name:n,ì§€ì—­:data.ì§€ì—­,ì§€ì—­2:data.ì§€ì—­2,totalCount:data.items.length,minPrice:ap.length?Math.min(...ap):0,maxPrice:ap.length?Math.max(...ap):0,types};
            });

            if(sortBy==='name')aptList.sort((a,b)=>a.name.localeCompare(b.name,'ko'));
            else if(sortBy==='count-desc')aptList.sort((a,b)=>b.totalCount-a.totalCount);
            else if(sortBy==='price-asc')aptList.sort((a,b)=>a.minPrice-b.minPrice);
            else if(sortBy==='price-desc')aptList.sort((a,b)=>b.maxPrice-a.maxPrice);

            document.getElementById('statAptCount').textContent=aptList.length;
            document.getElementById('statTotalCount').textContent=filtered.length;
            const allP=filtered.map(d=>d.ê°€ê²©ìˆ«ì).filter(p=>p>0);
            document.getElementById('statMinPrice').textContent=allP.length?fmtWon(Math.min(...allP)):'-';
            document.getElementById('statMaxPrice').textContent=allP.length?fmtWon(Math.max(...allP)):'-';
            renderChart(major, filtered);
            render(aptList);
        }

        function fmtWon(n) {
            if(!n) return '-';
            const abs=Math.abs(n), eok=Math.floor(abs/1e8), man=Math.floor((abs%1e8)/1e4);
            let s='';
            if(eok>0)s+=eok+'ì–µ';
            if(man>0)s+=' '+man.toLocaleString()+'ë§Œ';
            if(!s)s='0';
            return (n<0?'-':'')+s.trim();
        }

        function renderChart(major, filtered) {
            const section = document.getElementById('chartSection');
            if (!major) { section.classList.remove('show'); return; }
            section.classList.add('show');
            document.getElementById('chartTitle').textContent = major + ' ë‹¨ì§€ë³„ ìµœì €ê°€ ë¹„êµ';
            document.getElementById('chartSubtitle').textContent = '59mÂ² Â· 84mÂ² ê¸°ì¤€ Â· ë‚®ì€ ìˆœ';

            const aptMap = {};
            filtered.forEach(d => {
                const area = parseFloat(d.ì „ìš©) || 0;
                if (area < 55 || (area > 65 && area < 80) || area > 90) return;
                const type = area <= 65 ? '59' : '84';
                if (!aptMap[d.ë‹¨ì§€ëª…]) aptMap[d.ë‹¨ì§€ëª…] = {};
                if (!aptMap[d.ë‹¨ì§€ëª…][type]) aptMap[d.ë‹¨ì§€ëª…][type] = [];
                if (d.ê°€ê²©ìˆ«ì > 0) aptMap[d.ë‹¨ì§€ëª…][type].push(d.ê°€ê²©ìˆ«ì);
            });

            const chartData = Object.entries(aptMap).map(([name, types]) => ({
                name,
                min59: types['59'] ? Math.min(...types['59']) : 0,
                min84: types['84'] ? Math.min(...types['84']) : 0,
            })).filter(d => d.min59 > 0 || d.min84 > 0)
            .sort((a, b) => (a.min59 || a.min84) - (b.min59 || b.min84));

            if (!chartData.length) { section.classList.remove('show'); return; }

            const maxVal = Math.max(...chartData.map(d => Math.max(d.min59, d.min84)));
            const bars = document.getElementById('chartBars');
            bars.innerHTML = '';

            chartData.forEach(d => {
                const pct59 = d.min59 > 0 ? Math.max((d.min59 / maxVal) * 100, 3) : 0;
                const pct84 = d.min84 > 0 ? Math.max((d.min84 / maxVal) * 100, 3) : 0;

                let barsHtml = '';
                if (pct59) barsHtml += `<div class="chart-bar chart-bar-59" style="width:${pct59}%"></div>`;
                if (pct84) barsHtml += `<div class="chart-bar chart-bar-84" style="width:${pct84}%"></div>`;

                let valHtml = '';
                if (d.min59) valHtml += '<span style="color:#8CBBCF">' + fmtWon(d.min59) + '</span>';
                if (d.min59 && d.min84) valHtml += '<br>';
                if (d.min84) valHtml += '<span style="color:#CBAB8F">' + fmtWon(d.min84) + '</span>';

                bars.innerHTML += `<div class="chart-row">
                    <div class="chart-label" title="${d.name}">${d.name}</div>
                    <div class="chart-bars">${barsHtml}</div>
                    <div class="chart-val">${valHtml}</div>
                </div>`;
            });
        }

        function render(aptList) {
            const ct=document.getElementById('aptContainer');
            ct.innerHTML='';
            if(!aptList.length){ct.innerHTML='<div style="text-align:center;padding:60px;background:var(--card);border-radius:24px;color:#888;">ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';return;}

            aptList.forEach((apt,idx)=>{
                const card=document.createElement('div');
                card.className='apt-card';
                let rows='', panels='';
                apt.types.forEach((t,ti)=>{
                    const uid='d_'+idx+'_'+ti;
                    rows+=`<tr>
                        <td><span class="type-name">${t.ì „ìš©}mÂ²</span></td>
                        <td class="td-r"><span class="count-badge">${t.count}</span></td>
                        <td class="td-r price-min">${fmtWon(t.minPrice)}</td>
                        <td class="td-r price-max">${fmtWon(t.maxPrice)}</td>
                        <td class="td-r ${t.minP<0?'p-neg':'p-pos'}">${fmtWon(t.minP)}</td>
                        <td class="td-r ${t.maxP<0?'p-neg':'p-pos'}">${fmtWon(t.maxP)}</td>
                        <td class="td-r"><button class="detail-btn" onclick="toggleD('${uid}',this)">ìƒì„¸â–¼</button></td>
                    </tr>`;
                    panels+=`<tr id="${uid}" class="detail-panel"><td colspan="7" style="padding:0;"><div class="detail-inner"><table>
                        <tr><th>ë™</th><th>ì¸µ</th><th>ë°©í–¥</th><th class="r">ë§¤ë§¤ê°€</th><th class="r">Pê¸ˆì•¡</th><th>ë¹„ê³ </th></tr>
                        ${[...t.items].sort((a,b)=>a.ê°€ê²©ìˆ«ì-b.ê°€ê²©ìˆ«ì).map(d=>`<tr>
                            <td>${d.ë™}</td><td>${d.ì¸µ}</td><td>${d.ë°©í–¥}</td>
                            <td class="r" style="font-weight:600">${d.ê°€ê²©}</td>
                            <td class="r" style="font-weight:600;color:${d.Pê¸ˆì•¡ìˆ«ì<0?'var(--red)':d.Pê¸ˆì•¡ìˆ«ì>0?'var(--green)':'#888'}">${d.Pí…ìŠ¤íŠ¸||'-'}</td>
                            <td style="color:#888;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(d.ìƒì„¸ì„¤ëª…||'').replace(/"/g,'&quot;')}">${d.ìƒì„¸ì„¤ëª…||'-'}</td>
                        </tr>`).join('')}
                    </table></div></td></tr>`;
                });

                card.innerHTML=`
                    <div class="apt-card-header">
                        <div><div class="apt-name">ğŸ¢ ${apt.name}</div><div class="apt-location">${apt.ì§€ì—­} ${apt.ì§€ì—­2}</div></div>
                        <div class="apt-badges">
                            <span class="apt-badge badge-count">${apt.totalCount}ê±´</span>
                            <span class="apt-badge badge-range">${fmtWon(apt.minPrice)} ~ ${fmtWon(apt.maxPrice)}</span>
                        </div>
                    </div>
                    <div class="type-table-wrap"><table class="type-table">
                        <thead><tr><th>ì „ìš©ë©´ì </th><th class="r">ë§¤ë¬¼ ìˆ˜</th><th class="r">ìµœì €ê°€</th><th class="r">ìµœê³ ê°€</th><th class="r">P ìµœì €</th><th class="r">P ìµœê³ </th><th></th></tr></thead>
                        <tbody>${rows}${panels}</tbody>
                    </table></div>`;
                ct.appendChild(card);
            });
        }

        function toggleD(id,btn){const el=document.getElementById(id);el.classList.toggle('open');btn.textContent=el.classList.contains('open')?'ì ‘ê¸°â–²':'ìƒì„¸â–¼';}
        function showError(msg){document.getElementById('loadingSection').style.display='none';document.getElementById('errorSection').style.display='block';document.getElementById('errorMessage').innerHTML=msg;}
    </script>
</body>
</html>
