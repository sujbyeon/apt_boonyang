<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„íŒŒíŠ¸ ë¶„ì–‘ê¶Œ ìš”ì•½ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root { --navy:#022136; --gold:#A78569; --gold-light:#f5efe9; --red:#e74c3c; --green:#27ae60; --blue:#2980b9; --bg:#f5f5f7; --card:#fff; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:"Pretendard Variable",Pretendard,-apple-system,sans-serif; background:var(--bg); color:var(--navy); padding:48px 20px; display:flex; flex-direction:column; align-items:center; -webkit-font-smoothing:antialiased; letter-spacing:-0.02em; }
        .container { width:100%; max-width:1200px; }
        header { text-align:center; margin-bottom:48px; }
        h1 { font-size:38px; font-weight:800; letter-spacing:-0.05em; margin-bottom:8px; }
        .subtitle { font-size:17px; color:var(--gold); font-weight:600; }

        .top-stats { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:32px; }
        .top-stat { background:var(--card); border-radius:20px; padding:28px 20px; text-align:center; border:1px solid rgba(0,0,0,0.04); }
        .top-stat-icon { font-size:28px; margin-bottom:10px; }
        .top-stat-label { font-size:13px; color:#888; font-weight:500; margin-bottom:6px; }
        .top-stat-value { font-size:26px; font-weight:800; letter-spacing:-0.03em; }

        .filter-bar { background:var(--card); border-radius:20px; padding:24px 28px; margin-bottom:32px; display:flex; gap:16px; align-items:end; border:1px solid rgba(0,0,0,0.04); flex-wrap:wrap; }
        .filter-item { flex:1; min-width:160px; }
        .filter-item label { display:block; font-size:12px; font-weight:600; color:#888; margin-bottom:6px; }
        .filter-item select,.filter-item input { width:100%; padding:10px 14px; border:1px solid #e0e0e0; border-radius:12px; font-size:14px; font-family:inherit; background:#fff; }
        .filter-item select:focus,.filter-item input:focus { outline:none; border-color:var(--gold); }

        .apt-card { background:var(--card); border-radius:24px; margin-bottom:24px; border:1px solid rgba(0,0,0,0.04); overflow:hidden; }
        .apt-card-header { padding:28px 32px 20px; display:flex; justify-content:space-between; align-items:center; }
        .apt-name { font-size:22px; font-weight:800; letter-spacing:-0.03em; }
        .apt-location { font-size:14px; color:#888; font-weight:500; margin-top:4px; }
        .apt-badges { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .apt-badge { padding:8px 16px; border-radius:12px; font-size:14px; font-weight:700; }
        .badge-count { background:var(--gold-light); color:var(--gold); }
        .badge-range { background:#eef6ff; color:var(--blue); }

        .type-table-wrap { padding:0 32px 28px; }
        .type-table { width:100%; border-collapse:separate; border-spacing:0; }
        .type-table thead th { font-size:12px; font-weight:700; color:#888; padding:12px 14px; text-align:left; border-bottom:2px solid #f0f0f0; white-space:nowrap; }
        .type-table thead th.r { text-align:right; }
        .type-table tbody td { padding:14px; font-size:14px; font-weight:500; border-bottom:1px solid #f5f5f5; vertical-align:middle; }
        .type-table tbody tr:last-child td { border-bottom:none; }
        .type-table tbody tr:hover { background:#fafbfc; }
        .type-name { font-weight:700; color:var(--navy); }
        .type-area { font-size:13px; color:#999; font-weight:500; }
        .td-r { text-align:right; font-variant-numeric:tabular-nums; }
        .price-min { color:var(--green); font-weight:700; }
        .price-max { color:var(--red); font-weight:700; }
        .count-badge { display:inline-block; background:var(--gold-light); color:var(--gold); padding:3px 10px; border-radius:8px; font-weight:700; font-size:13px; }
        .p-neg { color:var(--red); font-weight:700; }
        .p-pos { color:var(--green); font-weight:700; }

        .detail-btn { background:none; border:1px solid #e0e0e0; border-radius:8px; padding:4px 10px; font-size:11px; font-family:inherit; cursor:pointer; color:#888; font-weight:600; transition:all 0.2s; }
        .detail-btn:hover { border-color:var(--gold); color:var(--gold); }
        .detail-panel { display:none; }
        .detail-panel.open { display:table-row; }
        .detail-inner { padding:12px 16px; background:#fafbfc; }
        .detail-inner table { width:100%; border-collapse:collapse; }
        .detail-inner th { font-size:11px; color:#999; font-weight:700; padding:6px 8px; text-align:left; }
        .detail-inner th.r { text-align:right; }
        .detail-inner td { font-size:13px; padding:8px; border-top:1px solid #eee; }
        .detail-inner td.r { text-align:right; }

        .loading-section { text-align:center; padding:100px 20px; background:var(--card); border-radius:24px; }
        .loading-icon { font-size:48px; animation:spin 2s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
        .loading-text { font-size:16px; color:#888; margin-top:16px; }
        .error-section { background:#fff5f5; border:2px solid #feb2b2; color:#c53030; padding:40px; border-radius:24px; text-align:center; display:none; }

        /* ì°¨íŠ¸ ì„¹ì…˜ */
        .chart-section { display:none; margin-bottom:32px; }
        .chart-section.show { display:block; }
        .chart-card { background:var(--card); border-radius:24px; padding:28px 32px; border:1px solid rgba(0,0,0,0.04); }
        .chart-title { font-size:16px; font-weight:700; margin-bottom:6px; letter-spacing:-0.03em; }
        .chart-subtitle { font-size:13px; color:#999; margin-bottom:20px; }
        .chart-legend { display:flex; gap:16px; margin-bottom:18px; }
        .legend-item { display:flex; align-items:center; gap:5px; font-size:12px; font-weight:600; color:#888; }
        .legend-dot { width:8px; height:8px; border-radius:50%; }
        .legend-59 { background:#8CBBCF; }
        .legend-84 { background:#CBAB8F; }
        .chart-row { display:flex; align-items:center; gap:10px; margin-bottom:6px; height:28px; }
        .chart-row:last-child { margin-bottom:0; }
        .chart-label { width:140px; min-width:140px; font-size:12px; font-weight:600; color:var(--navy); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:right; }
        .chart-bars { flex:1; display:flex; flex-direction:column; gap:2px; justify-content:center; }
        .chart-bar { height:12px; border-radius:3px; transition:width 0.5s ease; min-width:2px; }
        .chart-bar-59 { background:#8CBBCF; }
        .chart-bar-84 { background:#CBAB8F; }
        .chart-val { width:90px; min-width:90px; font-size:11px; font-weight:600; color:#999; font-variant-numeric:tabular-nums; line-height:1.5; }

        @media (max-width:768px) {
            body { padding:24px 12px; }
            .top-stats { grid-template-columns:repeat(2,1fr); gap:10px; }
            .top-stat { padding:20px 14px; border-radius:16px; }
            .top-stat-value { font-size:22px; }
            .filter-bar { flex-direction:column; padding:16px; gap:10px; border-radius:16px; margin-bottom:20px; }
            .filter-item { min-width:100%; }
            h1 { font-size:26px; }
            .subtitle { font-size:14px; }
            header { margin-bottom:28px; }

            /* ì°¨íŠ¸ ëª¨ë°”ì¼ */
            .chart-card { padding:20px 16px; border-radius:16px; }
            .chart-label { width:80px; min-width:80px; font-size:11px; }
            .chart-val { width:70px; min-width:70px; font-size:10px; }
            .chart-row { gap:6px; height:26px; }

            /* ì•„íŒŒíŠ¸ ì¹´ë“œ */
            .apt-card { border-radius:16px; margin-bottom:16px; }
            .apt-card-header { padding:20px 16px 14px; flex-direction:column; align-items:flex-start; gap:10px; }
            .apt-name { font-size:18px; }
            .apt-badges { gap:6px; }
            .apt-badge { padding:6px 12px; font-size:12px; border-radius:10px; }

            /* í…Œì´ë¸” â†’ ì¹´ë“œí˜• ì „í™˜ */
            .type-table-wrap { padding:0 16px 20px; overflow-x:visible; }
            .type-table thead { display:none; }
            .type-table, .type-table tbody { display:block; width:100%; }
            .type-table tbody tr.type-row { display:grid; grid-template-columns:1fr 1fr; gap:4px 12px; padding:14px; margin-bottom:8px; background:#f8f9fa; border-radius:12px; border-bottom:none !important; }
            .type-table tbody tr.type-row:hover { background:#f0f1f3; }
            .type-table tbody tr.type-row td { padding:0; border-bottom:none; font-size:13px; }
            .type-table tbody tr.type-row td.td-r { text-align:left; }
            .type-table tbody tr.type-row td:nth-child(1) { grid-column:1/-1; font-size:15px; font-weight:700; margin-bottom:4px; }
            .type-table tbody tr.type-row td:nth-child(2)::before { content:'ë§¤ë¬¼ '; font-size:11px; color:#888; }
            .type-table tbody tr.type-row td:nth-child(3)::before { content:'ìµœì € '; font-size:11px; color:#888; }
            .type-table tbody tr.type-row td:nth-child(4)::before { content:'ìµœê³  '; font-size:11px; color:#888; }
            .type-table tbody tr.type-row td:nth-child(5)::before { content:'P '; font-size:11px; color:#888; }
            .type-table tbody tr.type-row td:nth-child(6) { grid-column:1/-1; margin-top:4px; }
            .detail-btn { width:100%; padding:8px; font-size:12px; }

            /* ìƒì„¸ íŒ¨ë„ ëª¨ë°”ì¼ */
            .type-table tbody tr.detail-panel { display:none; }
            .type-table tbody tr.detail-panel.open { display:block; margin-bottom:8px; }
            .detail-panel td { padding:0 !important; }
            .detail-inner { padding:8px; border-radius:12px; }
            .detail-inner table { width:100%; }
            .detail-inner thead { display:none; }
            .detail-inner table tr { display:block; padding:10px 12px; margin-bottom:6px; background:#fff; border-radius:10px; border:1px solid #eee; }
            .detail-inner table tr:first-child { display:none; }
            .detail-inner table td { display:inline; padding:0 !important; font-size:13px; border:none !important; }
            .detail-inner table td:nth-child(1)::before { content:''; }
            .detail-inner table td:nth-child(1) { font-weight:700; }
            .detail-inner table td:nth-child(1)::after { content:' Â· '; color:#ccc; }
            .detail-inner table td:nth-child(2)::after { content:' Â· '; color:#ccc; }
            .detail-inner table td:nth-child(3)::after { content:'\A'; white-space:pre; }
            .detail-inner table td:nth-child(4) { font-weight:700; }
            .detail-inner table td:nth-child(4)::after { content:'  '; }
            .detail-inner table td:nth-child(6) { display:block; margin-top:4px; font-size:12px; color:#999 !important; white-space:normal; max-width:100%; overflow:visible; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¢ ë¶„ì–‘ê¶Œ ë§¤ë¬¼ ìš”ì•½</h1>
            <div class="subtitle">ì•„íŒŒíŠ¸ë³„ Â· í‰í˜•ë³„ ê°€ê²© ìš”ì•½ ëŒ€ì‹œë³´ë“œ</div>
        </header>

        <div style="background:#fff;border-radius:16px;padding:18px 28px;margin-bottom:32px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;gap:12px;flex-wrap:wrap;">
            <a href="https://blog.naver.com/chachalacha" target="_blank" style="text-decoration:none;text-align:center;padding:12px 20px;border-radius:12px;background:#f8f9fa;transition:all 0.2s;border:1px solid transparent;" onmouseover="this.style.background='#f0f0f2';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#f8f9fa';this.style.transform='none'">
                <div style="font-size:11px;color:#999;font-weight:600;margin-bottom:4px;">ì œì‘</div>
                <div style="font-size:14px;font-weight:800;color:var(--navy);">ìˆ˜ì”ì˜ ë¸”ë¡œê·¸</div>
            </a>
            <a href="https://blog.naver.com/po-tax/222638285211" target="_blank" style="text-decoration:none;text-align:center;padding:12px 20px;border-radius:12px;background:#f8f9fa;transition:all 0.2s;border:1px solid transparent;" onmouseover="this.style.background='#f0f0f2';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#f8f9fa';this.style.transform='none'">
                <div style="font-size:11px;color:#999;font-weight:600;margin-bottom:4px;">ì¬ê°œë°œ ì „ë¬¸ ì„¸ë¬´ìƒë‹´</div>
                <div style="font-size:14px;font-weight:800;color:var(--navy);">âš–ï¸ ì„¸ë¬´íšŒê³„ í‰ì˜¨</div>
            </a>
            <a href="https://contents.premium.naver.com/jejeguide/jejemvp" target="_blank" style="text-decoration:none;text-align:center;padding:12px 20px;border-radius:12px;background:#f8f9fa;transition:all 0.2s;border:1px solid transparent;" onmouseover="this.style.background='#f0f0f2';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#f8f9fa';this.style.transform='none'">
                <div style="font-size:11px;color:#999;font-weight:600;margin-bottom:4px;">í”„ë¦¬ë¯¸ì—„ ë§¤ë¬¼ ë¶„ì„</div>
                <div style="font-size:14px;font-weight:800;color:var(--navy);">ğŸ“ˆ ì¬ê°œë°œ ì¬ê±´ì¶• ì¶”ì²œë§¤ë¬¼ ìŠ¤í„°ë””</div>
            </a>
        </div>

        <div id="loadingSection" class="loading-section">
            <div class="loading-icon">â³</div>
            <div class="loading-text">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        </div>
        <div id="errorSection" class="error-section">
            <div style="font-size:48px;margin-bottom:16px;">âŒ</div>
            <div id="errorMessage" style="font-size:15px;line-height:1.8;"></div>
        </div>

        <div id="mainContent" style="display:none;">
            <div class="top-stats">
                <div class="top-stat"><div class="top-stat-icon">ğŸ </div><div class="top-stat-label">ì´ ë‹¨ì§€ ìˆ˜</div><div class="top-stat-value" id="statAptCount">0</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ“‹</div><div class="top-stat-label">ì´ ë§¤ë¬¼ ìˆ˜</div><div class="top-stat-value" id="statTotalCount">0</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ’°</div><div class="top-stat-label">ìµœì €ê°€</div><div class="top-stat-value" id="statMinPrice">-</div></div>
                <div class="top-stat"><div class="top-stat-icon">ğŸ“ˆ</div><div class="top-stat-label">ìµœê³ ê°€</div><div class="top-stat-value" id="statMaxPrice">-</div></div>
            </div>
            <div class="filter-bar">
                <div class="filter-item"><label>ê´‘ì—­ì‹œë„</label><select id="filterMajor" onchange="onMajorChange()"><option value="">ì „ì²´</option></select></div>
                <div class="filter-item"><label>ì„¸ë¶€ì§€ì—­</label><select id="filterMinor" onchange="applyFilters()"><option value="">ì „ì²´</option></select></div>
                <div class="filter-item"><label>ë‹¨ì§€ëª… ê²€ìƒ‰</label><input type="text" id="filterName" placeholder="ë‹¨ì§€ëª… ì…ë ¥" oninput="applyFilters()"></div>
                <div class="filter-item"><label>ì •ë ¬</label><select id="sortBy" onchange="applyFilters()"><option value="name">ì´ë¦„ìˆœ</option><option value="count-desc">ë§¤ë¬¼ ë§ì€ìˆœ</option><option value="price-asc">ìµœì €ê°€ ë‚®ì€ìˆœ</option><option value="price-desc">ìµœê³ ê°€ ë†’ì€ìˆœ</option></select></div>
            </div>
            <div id="chartSection" class="chart-section">
                <div class="chart-card">
                    <div class="chart-title" id="chartTitle">ë‹¨ì§€ë³„ ìµœì €ê°€ ë¹„êµ</div>
                    <div class="chart-subtitle" id="chartSubtitle">59mÂ² Â· 84mÂ² ê¸°ì¤€</div>
                    <div class="chart-legend">
                        <div class="legend-item"><div class="legend-dot legend-59"></div>59mÂ²</div>
                        <div class="legend-item"><div class="legend-dot legend-84"></div>84mÂ²</div>
                    </div>
                    <div id="chartBars"></div>
                </div>
            </div>
            <div id="aptContainer"></div>
        </div>
    </div>

    <script>
        let allData = [];
        const SHEET_URLS = [
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNbiO170sxkjo_rgOvvis5eTZP0VYfm1aYetd792BcWwXs-b1BsRtX9DQha6LlZkfRIIE_4IIeplIM/pub?gid=0&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNbiO170sxkjo_rgOvvis5eTZP0VYfm1aYetd792BcWwXs-b1BsRtX9DQha6LlZkfRIIE_4IIeplIM/pub?gid=614527479&single=true&output=csv',
            'https://docs.google.com/spreadsheets/d/e/2PACX-1vTNbiO170sxkjo_rgOvvis5eTZP0VYfm1aYetd792BcWwXs-b1BsRtX9DQha6LlZkfRIIE_4IIeplIM/pub?gid=653792883&single=true&output=csv',
        ];
        window.onload = loadData;

        async function fetchOne(url) {
            const proxies = [
                url,
                'https://api.allorigins.win/raw?url='+encodeURIComponent(url),
                'https://corsproxy.io/?'+encodeURIComponent(url),
            ];
            const timeout = new Promise((_,r)=>setTimeout(()=>r('timeout'),6000));
            try {
                const text = await Promise.race([...proxies.map(u=>fetch(u).then(r=>{if(!r.ok)throw 0;return r.text()}).then(t=>{if(t.length<20)throw 0;return t;})), timeout]);
                return text;
            } catch(e) { return null; }
        }

        async function loadData() {
            try {
                const results = await Promise.all(SHEET_URLS.map(u=>fetchOne(u)));
                const validResults = results.filter(t=>t);
                if(!validResults.length){showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>êµ¬ê¸€ ì‹œíŠ¸ ì›¹ ê²Œì‹œ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');return;}
                allData = [];
                validResults.forEach(text=>parseCSV(text));
                buildRegionFilter();applyFilters();
                document.getElementById('loadingSection').style.display='none';
                document.getElementById('mainContent').style.display='block';
            } catch(e){showError('íŒŒì‹± ì‹¤íŒ¨: '+e.message);}
        }

        function parseCSV(text) {
            const lines = csvParse(text);
            if (lines.length < 2) return;

            const h = lines[0].map(s => s.trim());
            const fi = (kw) => h.findIndex(col => kw.every(k => col.includes(k)));
            const exact = (name) => h.findIndex(c => c.trim() === name);
            const I = {
                ì§€ì—­: exact('ì§€ì—­') >= 0 ? exact('ì§€ì—­') : fi(['ì§€ì—­']),
                ì§€ì—­ëª…: fi(['ì§€ì—­ëª…']) >= 0 ? fi(['ì§€ì—­ëª…']) : -1,
                ë‹¨ì§€ëª…: fi(['ë‹¨ì§€ëª…']),
                ë™: exact('ë™'),
                ë§¤ë¬¼ë°©ì‹: fi(['ë§¤ë¬¼ë°©ì‹']),
                ì „ìš©: fi(['ì „ìš©']),
                ì¸µ: exact('ì¸µ'),
                íŠ¹ì´ì‚¬í•­: fi(['íŠ¹ì´ì‚¬í•­']),
                í™•ì¸ë§¤ë¬¼: fi(['í™•ì¸ë§¤ë¬¼']),
                ê±°ë˜ê°€ì•¡: fi(['ê±°ë˜ê°€ì•¡']),
                ì›”ì„¸: fi(['ì›”ì„¸']),
                ìµœì†ŒP: fi(['ìµœì†ŒP']) >= 0 ? fi(['ìµœì†ŒP']) : exact('ìµœì†ŒP'),
                ìµœëŒ€P: fi(['ìµœëŒ€P']) >= 0 ? fi(['ìµœëŒ€P']) : exact('ìµœëŒ€P'),
                ë°©í–¥: fi(['ë°©í–¥']),
                ë¶€ë™ì‚°: fi(['ë¶€ë™ì‚°']),
                ë§¤ë¬¼URL: fi(['ë§¤ë¬¼URL']) >= 0 ? fi(['ë§¤ë¬¼URL']) : fi(['URL']),
            };

            for (let i = 1; i < lines.length; i++) {
                const c = lines[i];
                const name = gc(c, I.ë‹¨ì§€ëª…);
                if (!name) continue;

                // ê±°ë˜ê°€ì•¡ì€ ë§Œì› ë‹¨ìœ„ â†’ ì› ë‹¨ìœ„ë¡œ ë³€í™˜
                const rawPrice = gc(c, I.ê±°ë˜ê°€ì•¡);
                const priceMan = numParse(rawPrice);
                const price = priceMan > 0 && isFinite(priceMan) ? priceMan * 10000 : 0;

                allData.push({
                    ì§€ì—­: gc(c, I.ì§€ì—­),
                    ì§€ì—­2: gc(c, I.ì§€ì—­ëª…),
                    ë‹¨ì§€ëª…: name,
                    ë™: gc(c, I.ë™),
                    ë§¤ë¬¼ë°©ì‹: gc(c, I.ë§¤ë¬¼ë°©ì‹),
                    ì „ìš©: gc(c, I.ì „ìš©),
                    ì¸µ: gc(c, I.ì¸µ),
                    íŠ¹ì´ì‚¬í•­: gc(c, I.íŠ¹ì´ì‚¬í•­),
                    í™•ì¸ì¼: gc(c, I.í™•ì¸ë§¤ë¬¼),
                    ê°€ê²©ìˆ«ì: price,
                    ì›”ì„¸: gc(c, I.ì›”ì„¸),
                    ìµœì†ŒP: gc(c, I.ìµœì†ŒP),
                    ìµœëŒ€P: gc(c, I.ìµœëŒ€P),
                    ë°©í–¥: gc(c, I.ë°©í–¥),
                    ë¶€ë™ì‚°: gc(c, I.ë¶€ë™ì‚°),
                    ë§¤ë¬¼URL: gc(c, I.ë§¤ë¬¼URL),
                });
            }
        }

        function gc(arr, i) { return (i >= 0 && i < arr.length) ? arr[i].trim() : ''; }
        function numParse(s) { return parseFloat((s||'').replace(/,/g, '')) || 0; }

        function csvParse(text) {
            const result = []; let row=[], cell='', inQ=false;
            for (let i=0; i<text.length; i++) {
                const ch=text[i], nx=text[i+1];
                if(inQ){if(ch==='"'&&nx==='"'){cell+='"';i++;}else if(ch==='"')inQ=false;else cell+=ch;}
                else{if(ch==='"')inQ=true;else if(ch===','){row.push(cell);cell='';}else if(ch==='\n'||(ch==='\r'&&nx==='\n')){row.push(cell);if(row.some(c=>c.trim()))result.push(row);row=[];cell='';if(ch==='\r')i++;}else cell+=ch;}
            }
            if(cell||row.length){row.push(cell);if(row.some(c=>c.trim()))result.push(row);}
            return result;
        }

        function getMajor(r) {
            const map = [['ì„œìš¸'],['ê²½ê¸°'],['ì¸ì²œ'],['ë¶€ì‚°'],['ëŒ€êµ¬'],['ëŒ€ì „'],['ê´‘ì£¼'],['ìš¸ì‚°'],['ì„¸ì¢…'],['ì¶©ë¶','ì¶©ì²­ë¶'],['ì¶©ë‚¨','ì¶©ì²­ë‚¨'],['ì „ë¶','ì „ë¼ë¶'],['ì „ë‚¨','ì „ë¼ë‚¨'],['ê²½ë¶','ê²½ìƒë¶'],['ê²½ë‚¨','ê²½ìƒë‚¨'],['ê°•ì›'],['ì œì£¼']];
            for (const m of map) { for (const prefix of m) { if (r.startsWith(prefix)) return m[0]; } }
            return r;
        }

        function buildRegionFilter() {
            const mm = {};
            allData.forEach(d => { const m = getMajor(d.ì§€ì—­); if(!mm[m])mm[m]=new Set(); mm[m].add(d.ì§€ì—­2); });
            const sel = document.getElementById('filterMajor');
            const order = ['ì„œìš¸','ê²½ê¸°','ì¸ì²œ','ë¶€ì‚°','ëŒ€êµ¬','ëŒ€ì „','ê´‘ì£¼','ìš¸ì‚°','ì„¸ì¢…'];
            Object.keys(mm).sort((a,b) => { const ai=order.indexOf(a),bi=order.indexOf(b); if(ai!==-1&&bi!==-1)return ai-bi; if(ai!==-1)return -1; if(bi!==-1)return 1; return a.localeCompare(b,'ko'); }).forEach(m => {
                const o = document.createElement('option'); o.value=m; o.textContent=m+' ('+mm[m].size+'ê°œ êµ¬/ì‹œ)'; sel.appendChild(o);
            });
            window._mm = mm;
        }

        function onMajorChange() {
            const major = document.getElementById('filterMajor').value;
            const ms = document.getElementById('filterMinor');
            ms.innerHTML = '<option value="">ì „ì²´</option>';
            if (major && window._mm[major]) {
                [...window._mm[major]].sort((a,b)=>a.localeCompare(b,'ko')).forEach(m => {
                    const cnt = new Set(allData.filter(d=>getMajor(d.ì§€ì—­)===major&&d.ì§€ì—­2===m).map(d=>d.ë‹¨ì§€ëª…)).size;
                    const o=document.createElement('option');o.value=m;o.textContent=m+' ('+cnt+'ê°œ ë‹¨ì§€)';ms.appendChild(o);
                });
            }
            applyFilters();
        }

        function applyFilters() {
            const major=document.getElementById('filterMajor').value;
            const minor=document.getElementById('filterMinor').value;
            const name=document.getElementById('filterName').value.toLowerCase();
            const sortBy=document.getElementById('sortBy').value;
            let filtered=allData.filter(d=>(!major||getMajor(d.ì§€ì—­)===major)&&(!minor||d.ì§€ì—­2===minor)&&(!name||d.ë‹¨ì§€ëª….toLowerCase().includes(name)));

            const am={};
            filtered.forEach(d=>{const k=d.ë‹¨ì§€ëª…;if(!am[k])am[k]={ì§€ì—­:d.ì§€ì—­,ì§€ì—­2:d.ì§€ì—­2,items:[]};am[k].items.push(d);});
            let aptList=Object.entries(am).map(([n,data])=>{
                const tm={};
                data.items.forEach(d=>{const k=Math.round(parseFloat(d.ì „ìš©))||d.ì „ìš©;if(!tm[k])tm[k]={ì „ìš©:k,items:[]};tm[k].items.push(d);});
                const types=Object.values(tm).map(t=>{
                    const pr=t.items.map(i=>i.ê°€ê²©ìˆ«ì).filter(p=>p>0);
                    const pMins=t.items.map(i=>parseP(i.ìµœì†ŒP)).filter(p=>p!==null&&isFinite(p));
                    return{ì „ìš©:t.ì „ìš©,count:t.items.length,minPrice:pr.length?Math.min(...pr):0,maxPrice:pr.length?Math.max(...pr):0,minP:pMins.length?Math.min(...pMins):null,maxP:pMins.length?Math.max(...pMins):null,items:t.items};
                });
                const ap=data.items.map(i=>i.ê°€ê²©ìˆ«ì).filter(p=>p>0);
                return{name:n,ì§€ì—­:data.ì§€ì—­,ì§€ì—­2:data.ì§€ì—­2,totalCount:data.items.length,minPrice:ap.length?Math.min(...ap):0,maxPrice:ap.length?Math.max(...ap):0,types};
            });

            if(sortBy==='name')aptList.sort((a,b)=>a.name.localeCompare(b.name,'ko'));
            else if(sortBy==='count-desc')aptList.sort((a,b)=>b.totalCount-a.totalCount);
            else if(sortBy==='price-asc')aptList.sort((a,b)=>a.minPrice-b.minPrice);
            else if(sortBy==='price-desc')aptList.sort((a,b)=>b.maxPrice-a.maxPrice);

            document.getElementById('statAptCount').textContent=aptList.length;
            document.getElementById('statTotalCount').textContent=filtered.length;
            const allP=filtered.map(d=>d.ê°€ê²©ìˆ«ì).filter(p=>p>0);
            document.getElementById('statMinPrice').textContent=allP.length?fmtWon(Math.min(...allP)):'-';
            document.getElementById('statMaxPrice').textContent=allP.length?fmtWon(Math.max(...allP)):'-';
            renderChart(major, minor, filtered);
            render(aptList);
        }

        function fmtWon(n) {
            if(n===null||n===undefined||isNaN(n)||!isFinite(n)) return '-';
            if(!n) return '0';
            const neg=n<0;
            const abs=Math.abs(n), eok=Math.floor(abs/1e8), man=Math.floor((abs%1e8)/1e4);
            let s='';
            if(eok>0)s+=eok+'ì–µ';
            if(man>0)s+=' '+man.toLocaleString()+'ë§Œ';
            if(!s)s='0';
            return (neg?'-':'')+s.trim();
        }

        // "1ì–µ 1,893" or "-4,000" or "2ì–µ 5,850" â†’ ì› ë‹¨ìœ„ ìˆ«ì
        function parseP(text) {
            if(!text||!text.trim()) return null;
            let s=text.trim();
            let neg=false;
            if(s.startsWith('-')){neg=true;s=s.substring(1).trim();}
            let total=0;
            const eokM=s.match(/(\d+)\s*ì–µ/);
            if(eokM) total+=parseInt(eokM[1])*1e8;
            // ì–µ ë’¤ì˜ ìˆ«ì ë˜ëŠ” ì–µ ì—†ì´ ìˆ«ìë§Œ
            let manPart=s.replace(/\d+\s*ì–µ\s*/,'').trim();
            if(!manPart&&!eokM) manPart=s;
            if(manPart){
                const num=parseFloat(manPart.replace(/,/g,''));
                if(!isNaN(num)){
                    // ë§Œì› ë‹¨ìœ„ì¸ì§€ íŒë‹¨: ì–µì´ ìˆìœ¼ë©´ ë’¤ì˜ ìˆ«ìëŠ” ë§Œì›ë‹¨ìœ„
                    if(eokM) total+=num*1e4;
                    else total+=num*1e4; // ì–µ ì—†ì´ ìˆ«ìë§Œì´ë©´ ë§Œì›ë‹¨ìœ„
                }
            }
            return neg?-total:total;
        }

        function renderChart(major, minor, filtered) {
            const section = document.getElementById('chartSection');
            if (!major) { section.classList.remove('show'); return; }
            section.classList.add('show');

            const label = minor ? major + ' ' + minor : major;
            document.getElementById('chartTitle').textContent = label + ' ë‹¨ì§€ë³„ ìµœì €ê°€ ë¹„êµ';
            document.getElementById('chartSubtitle').textContent = '59mÂ² Â· 84mÂ² ê¸°ì¤€ Â· ë‚®ì€ ìˆœ';

            const aptMap = {};
            filtered.forEach(d => {
                const area = parseFloat(d.ì „ìš©) || 0;
                if (area < 55 || (area > 65 && area < 80) || area > 90) return;
                const type = area <= 65 ? '59' : '84';
                if (!aptMap[d.ë‹¨ì§€ëª…]) aptMap[d.ë‹¨ì§€ëª…] = {};
                if (!aptMap[d.ë‹¨ì§€ëª…][type]) aptMap[d.ë‹¨ì§€ëª…][type] = [];
                if (d.ê°€ê²©ìˆ«ì > 0) aptMap[d.ë‹¨ì§€ëª…][type].push(d.ê°€ê²©ìˆ«ì);
            });

            const chartData = Object.entries(aptMap).map(([name, types]) => ({
                name,
                min59: types['59'] ? Math.min(...types['59']) : 0,
                min84: types['84'] ? Math.min(...types['84']) : 0,
            })).filter(d => (d.min59 > 0 && isFinite(d.min59)) || (d.min84 > 0 && isFinite(d.min84)))
            .sort((a, b) => (a.min59 || a.min84) - (b.min59 || b.min84));

            if (!chartData.length) { section.classList.remove('show'); return; }

            const maxVal = Math.max(...chartData.map(d => Math.max(d.min59||0, d.min84||0)).filter(isFinite));
            const bars = document.getElementById('chartBars');
            bars.innerHTML = '';

            chartData.forEach(d => {
                const pct59 = d.min59 > 0 && isFinite(d.min59) ? Math.max((d.min59 / maxVal) * 100, 3) : 0;
                const pct84 = d.min84 > 0 && isFinite(d.min84) ? Math.max((d.min84 / maxVal) * 100, 3) : 0;

                let barsHtml = '';
                if (pct59) barsHtml += `<div class="chart-bar chart-bar-59" style="width:${pct59}%"></div>`;
                if (pct84) barsHtml += `<div class="chart-bar chart-bar-84" style="width:${pct84}%"></div>`;

                let valHtml = '';
                if (d.min59 && isFinite(d.min59)) valHtml += '<span style="color:#8CBBCF">' + fmtWon(d.min59) + '</span>';
                if (d.min59 && d.min84 && isFinite(d.min59) && isFinite(d.min84)) valHtml += '<br>';
                if (d.min84 && isFinite(d.min84)) valHtml += '<span style="color:#CBAB8F">' + fmtWon(d.min84) + '</span>';

                bars.innerHTML += `<div class="chart-row">
                    <div class="chart-label" title="${d.name}">${d.name}</div>
                    <div class="chart-bars">${barsHtml}</div>
                    <div class="chart-val">${valHtml}</div>
                </div>`;
            });
        }

        function render(aptList) {
            const ct=document.getElementById('aptContainer');
            ct.innerHTML='';
            if(!aptList.length){ct.innerHTML='<div style="text-align:center;padding:60px;background:var(--card);border-radius:24px;color:#888;">ğŸ” ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';return;}

            aptList.forEach((apt,idx)=>{
                const card=document.createElement('div');
                card.className='apt-card';
                let rows='';
                apt.types.forEach((t,ti)=>{
                    const uid='d_'+idx+'_'+ti;
                    rows+=`<tr class="type-row">
                        <td><span class="type-name">${Math.round(parseFloat(t.ì „ìš©))}mÂ²</span></td>
                        <td class="td-r"><span class="count-badge">${t.count}</span></td>
                        <td class="td-r price-min">${fmtWon(t.minPrice)}</td>
                        <td class="td-r price-max">${fmtWon(t.maxPrice)}</td>
                        <td class="td-r ${t.minP!==null&&t.minP<0?'p-neg':'p-pos'}">${t.minP!==null?fmtWon(t.minP):'-'}</td>
                        <td class="td-r"><button class="detail-btn" onclick="toggleD('${uid}',this)">ìƒì„¸â–¼</button></td>
                    </tr>`;
                    rows+=`<tr id="${uid}" class="detail-panel"><td colspan="6" style="padding:0;"><div class="detail-inner"><table>
                        <tr><th>ë™</th><th>ì¸µ</th><th>ë°©í–¥</th><th class="r">ë§¤ë§¤ê°€</th><th class="r">P</th><th>ë¹„ê³ </th></tr>
                        ${[...t.items].sort((a,b)=>a.ê°€ê²©ìˆ«ì-b.ê°€ê²©ìˆ«ì).map(d=>{
                            const pVal=parseP(d.ìµœì†ŒP);
                            return `<tr>
                            <td>${d.ë™}</td><td>${d.ì¸µ}</td><td>${d.ë°©í–¥}</td>
                            <td class="r" style="font-weight:600">${fmtWon(d.ê°€ê²©ìˆ«ì)}</td>
                            <td class="r" style="font-weight:600;color:${pVal!==null&&pVal<0?'var(--red)':pVal!==null&&pVal>0?'var(--green)':'#888'}">${d.ìµœì†ŒP||'-'}</td>
                            <td style="color:#888;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(d.íŠ¹ì´ì‚¬í•­||'').replace(/"/g,'&quot;')}">${d.ë§¤ë¬¼URL?'<a href="'+d.ë§¤ë¬¼URL+'" target="_blank" style="color:var(--gold);text-decoration:none;">ğŸ”—</a> ':''}${d.íŠ¹ì´ì‚¬í•­||'-'}</td>
                        </tr>`}).join('')}
                    </table></div></td></tr>`;
                });

                card.innerHTML=`
                    <div class="apt-card-header">
                        <div><div class="apt-name">ğŸ¢ ${apt.name}</div><div class="apt-location">${apt.ì§€ì—­} ${apt.ì§€ì—­2}</div></div>
                        <div class="apt-badges">
                            <span class="apt-badge badge-count">${apt.totalCount}ê±´</span>
                            <span class="apt-badge badge-range">${fmtWon(apt.minPrice)} ~ ${fmtWon(apt.maxPrice)}</span>
                        </div>
                    </div>
                    <div class="type-table-wrap"><table class="type-table">
                        <thead><tr><th>ì „ìš©ë©´ì </th><th class="r">ë§¤ë¬¼ ìˆ˜</th><th class="r">ìµœì €ê°€</th><th class="r">ìµœê³ ê°€</th><th class="r">P</th><th></th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table></div>`;
                ct.appendChild(card);
            });
        }

        function toggleD(id,btn){const el=document.getElementById(id);el.classList.toggle('open');btn.textContent=el.classList.contains('open')?'ì ‘ê¸°â–²':'ìƒì„¸â–¼';}
        function showError(msg){document.getElementById('loadingSection').style.display='none';document.getElementById('errorSection').style.display='block';document.getElementById('errorMessage').innerHTML=msg;}
    </script>
</body>
</html>
